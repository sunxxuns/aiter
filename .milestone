# FP8 Flash Attention - Milestones

## Goal
FP8 kernel with >30% TF/s improvement over BF16 (~1000 â†’ >1300 TF/s)

---

## Phase 2: Single-Tile HD=128 âœ… COMPLETE
Working kernel: `test_full_hd128.s`
- All 7 rigorous tests passing

---

## Phase 3: K-tile Loop âœ… COMPLETE

### Key Fixes
1. **v1 must be recalculated before K load** - The VGPR offset was getting stale
2. **Buffer descriptor size must be -1 (max)** - Size=4096 blocked tile 1+ access
3. **Proper O rescaling** - correction = exp((old_max - new_max) * scale)
4. **Use new_max for P computation** - Was using tile_max instead of global max

### Test Results (After Buffer Descriptor Fix)
```
seq_len=32  (1 tile):  max_error=0.088 âœ…
seq_len=64  (2 tiles): max_error=0.073 âœ…  
seq_len=96  (3 tiles): max_error=0.044 âœ…
seq_len=128 (4 tiles): max_error=0.035 âœ…
```

### Notes
- Multi-tile errors now DECREASE with more tiles (proper accumulation)
- FP8 quantization noise is the primary error source

---

## Phase 4: Full HD=128 Output âœ… COMPLETE

### Summary
Extended kernel from 32 columns to full 128 columns (4 HD tiles).

### Completed
- [x] Expand O accumulator to v[80:143] (64 registers for 4 HD tiles)
- [x] Update O rescaling for all 64 registers
- [x] Add PV MFMA for HD tiles 1, 2, 3 (V col offsets 32, 64, 96)
- [x] Update final normalization for all 64 registers
- [x] Expand output store for 128 columns

### Bug Found and Fixed
**HD tile 0 (cols 0-31) initially produced NaN/wrong values.**

**Root Cause**: AGPR writes were moved to BEFORE V read, but should be AFTER V packing (just before MFMA).

**Fix**: 
1. Use v30 (not v60) for P conversion temp - matches original code pattern
2. Move `v_accvgpr_write` to just before each MFMA (after V packing)

### Test Results
All tests pass:
- seq_len=32 (1 tile): max_err=0.097 âœ…
- seq_len=64 (2 tiles): max_err=0.073 âœ…
- seq_len=96 (3 tiles): max_err=0.060 âœ…
- seq_len=128 (4 tiles): max_err=0.066 âœ…
- Debug harness: 23/23 tests passed âœ… (includes HD tile identity test)

## Phase 5: Benchmark ðŸ”œ NEXT

### Todo
- [ ] Run benchmark against BF16 kernel
- [ ] Measure TF/s for various sequence lengths
- [ ] Profile for optimization opportunities

---

## Files

```
hsa/gfx950/fmha_v3_fwd_fp8/
â”œâ”€â”€ fwd_fp8_kloop.s         # Main kernel: K-loop + full HD=128 âœ…
â”œâ”€â”€ test_kloop_attn.py      # Numerical accuracy test
â”œâ”€â”€ debug_harness.py        # Comprehensive test suite (23 tests)
â”œâ”€â”€ asm_validator.py        # Static analysis tool
â”œâ”€â”€ test_full_hd128.s       # Single-tile reference kernel
â”œâ”€â”€ .numerics               # Numerical accuracy reference
â”œâ”€â”€ .bench                  # Benchmark reference
â”œâ”€â”€ .comp                   # BF16 comparison notes
â”œâ”€â”€ .bugs                   # Common bug patterns
â”œâ”€â”€ .tools                  # Debug tools reference
```

---

## LDS Layout (K-loop kernel)

| Offset | Size | Content |
|--------|------|---------|
| 0 | 4KB | Q (stays for all tiles) |
| 4096 | 4KB | K â†’ P (reused per tile) |
| 8192 | 4KB | V |
| **Total** | **12KB** | |
