# FP8 Flash Attention - Milestones

## Goal
FP8 kernel with >30% TF/s improvement over BF16 (~1000 â†’ >1300 TF/s)

---

## Phase 2: Single-Tile HD=128 âœ… COMPLETE
Working kernel: `test_full_hd128.s`
- All 7 rigorous tests passing

---

## Phase 3: K-tile Loop ðŸ”„ IN PROGRESS

### Completed âœ…
- [x] K-loop structure verified (test_kloop.py)
- [x] buffer_load with scalar offset works
- [x] Loop control with s_cbranch_scc1 works
- [x] `.args` metadata requirement discovered
- [x] Created fwd_fp8_kloop.s with online softmax structure

### Progress âœ…
Single-tile (seq=32) now passes with perfect match!
- Root cause: `accum_offset` metadata was wrong (96 vs 64)
- MFMA requires correct VGPR/AGPR boundary

### Current Issue ðŸŸ¡
Multi-tile (seq > 32): K-loop runs but only uses first tile
- All seq_len produce same output as seq=32
- Per-tile P normalization complicates multi-tile accumulation

### Next Steps
- [ ] Implement proper online softmax (no per-tile P normalization)
- [ ] Test with multiple K-tiles
- [ ] Match BF16 online softmax pattern

---

## Files

```
hsa/gfx950/fmha_v3_fwd_fp8/
â”œâ”€â”€ test_full_hd128.s       # Working single-tile kernel âœ…
â”œâ”€â”€ fwd_fp8_kloop.s         # K-loop kernel (numerical bug)
â”œâ”€â”€ test_kloop_attn.py      # K-loop attention test
â”œâ”€â”€ test_kloop.s/py         # K-loop structure test âœ…
â”œâ”€â”€ debug_bufload.s/py      # buffer_load test âœ…
â”œâ”€â”€ test_rigorous.py        # Phase 2 tests âœ…
```

---

## LDS Layout (K-loop kernel)

| Offset | Size | Content |
|--------|------|---------|
| 0 | 4KB | Q (stays for all tiles) |
| 4096 | 4KB | K â†’ P (reused) |
| 8192 | 4KB | V |
| **Total** | **12KB** | |
