# FP8 Flash Attention - Milestones

## Goal
FP8 kernel with >30% TF/s improvement over BF16 (~1000 â†’ >1300 TF/s)

---

## Phase 2: Single-Tile HD=128 âœ… COMPLETE

- S^T = K @ Q^T computation
- Row-wise softmax via VGPR sum + permlane32_swap
- P transpose store for PV MFMA
- All 7 rigorous tests passing

---

## Phase 3: K-tile Loop ðŸ”„ IN PROGRESS

### Completed âœ…
- [x] buffer_load with scalar offset verified
- [x] K-loop structure verified (test_kloop.py)
- [x] Scalar offset advancement works (1, 2, 4, 8 tiles)
- [x] Loop control with s_cbranch_scc1 works

### Next Steps
- [ ] Integrate K-loop into test_full_hd128.s
- [ ] Add online softmax (running max/sum across tiles)
- [ ] Add O rescaling: O *= exp(old_max - new_max)
- [ ] Test with real FP8 attention

---

## Verified K-Loop Pattern

```asm
// Setup
s_mov_b32 s18, 0                        // k_offset = 0
s_mov_b32 s19, stride                   // k_stride (bytes per tile)
s_mov_b32 s20, 0                        // tile_idx = 0

K_LOOP:
    buffer_load_dword v, voff, s[8:11], s18 offen
    s_waitcnt vmcnt(0)
    // ... process tile ...
    s_add_i32 s18, s18, s19              // k_offset += k_stride
    s_add_i32 s20, s20, 1                // tile_idx++
    s_cmp_lt_i32 s20, s17                // if tile_idx < num_tiles
    s_cbranch_scc1 K_LOOP
```

---

## Test Results

| Tiles | Seq Len | Status |
|-------|---------|--------|
| 1 | 32 | âœ… |
| 2 | 64 | âœ… |
| 4 | 128 | âœ… |
| 8 | 256 | âœ… |

---

## Files

```
hsa/gfx950/fmha_v3_fwd_fp8/
â”œâ”€â”€ test_full_hd128.s       # Production single-tile kernel
â”œâ”€â”€ test_kloop.s            # K-loop test kernel âœ…
â”œâ”€â”€ test_kloop.py           # K-loop test script âœ…
â”œâ”€â”€ debug_bufload.s/py      # buffer_load debug
â”œâ”€â”€ test_rigorous.py        # Phase 2 test suite
```
