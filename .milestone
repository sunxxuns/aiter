# FP8 Flash Attention - Milestones

## Goal
FP8 kernel with >30% TF/s improvement over BF16 (~1000 â†’ >1300 TF/s)

---

## Phase 2: Single-Tile HD=128 âœ… COMPLETE
Working kernel: `test_full_hd128.s`
- All 7 rigorous tests passing

---

## Phase 3: K-tile Loop ðŸ”„ IN PROGRESS

### Completed âœ…
- [x] K-loop structure verified (test_kloop.py)
- [x] buffer_load with scalar offset works
- [x] Loop control with s_cbranch_scc1 works
- [x] `.args` metadata requirement discovered
- [x] Created fwd_fp8_kloop.s with online softmax structure

### Current Issue ðŸ”´
`fwd_fp8_kloop.s` compiles and runs, but numerical results are wrong:
- Single-tile (seq=32): Output ~100x too large
- Multi-tile: Some produce zeros, some pass by accident

### Debug Notes
1. QK MFMA uses AGPRs correctly (matched working kernel)
2. P storage at LDS offset 4096, V at 8192
3. Output store uses correct formula (row*128 + col)*4
4. Issue likely in P normalization or FP8 conversion

### Next Steps
- [ ] Debug P normalization vs working kernel
- [ ] Verify FP8 conversion doesn't lose precision  
- [ ] Add intermediate value checks
- [ ] Compare exact MFMA operand values

---

## Files

```
hsa/gfx950/fmha_v3_fwd_fp8/
â”œâ”€â”€ test_full_hd128.s       # Working single-tile kernel âœ…
â”œâ”€â”€ fwd_fp8_kloop.s         # K-loop kernel (numerical bug)
â”œâ”€â”€ test_kloop_attn.py      # K-loop attention test
â”œâ”€â”€ test_kloop.s/py         # K-loop structure test âœ…
â”œâ”€â”€ debug_bufload.s/py      # buffer_load test âœ…
â”œâ”€â”€ test_rigorous.py        # Phase 2 tests âœ…
```

---

## LDS Layout (K-loop kernel)

| Offset | Size | Content |
|--------|------|---------|
| 0 | 4KB | Q (stays for all tiles) |
| 4096 | 4KB | K â†’ P (reused) |
| 8192 | 4KB | V |
| **Total** | **12KB** | |
