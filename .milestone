# FP8 Flash Attention - Milestones

## Goal
FP8 kernel with >30% TF/s improvement over BF16 (~1000 â†’ >1300 TF/s)

---

## Phase 2: Single-Tile HD=128 âœ… COMPLETE

- S^T = K @ Q^T computation
- Row-wise softmax via VGPR sum + permlane32_swap
- P transpose store for PV MFMA
- All 7 rigorous tests passing

---

## Phase 3: K-tile Loop ðŸ”„ IN PROGRESS

### Completed âœ…
- [x] buffer_load with scalar offset verified (debug_bufload.py)
- [x] Discovered `.args` metadata requirement
- [x] Documented BF16 K-loop patterns in .comp

### Next Steps
- [ ] Add seq_len kernel argument to test_full_hd128.s
- [ ] Add K-tile loop with scalar offset advancement
- [ ] Implement online softmax (running max/sum)
- [ ] Implement O rescaling between tiles
- [ ] Test with seq_len = 64, 128, 256

---

## BF16 K-Loop Reference

```asm
// Offset management
s_mov_b32 s34, 0                       // K offset = 0
s_mul_i32 s43, 64, s47                 // K stride

// Loop body
buffer_load_dwordx4 v4, s[12:15], s34 offen lds
s_add_i32 s34, s43, s34                // Advance offset

// Loop control
s_add_i32 s52, s52, s53                // tile_idx += tile_size
s_cmp_lt_i32 s52, s54                  // if tile_idx < seq_len
s_cbranch_scc1 LOOP_START
```

---

## Files

```
hsa/gfx950/fmha_v3_fwd_fp8/
â”œâ”€â”€ test_full_hd128.s       # Production single-tile kernel
â”œâ”€â”€ debug_bufload.s         # buffer_load offset test âœ…
â”œâ”€â”€ debug_bufload.py        # Test script âœ…
â”œâ”€â”€ test_rigorous.py        # Phase 2 test suite
```

---

## Performance Targets

| Seq Len | BF16 TF/s | FP8 Target | Status |
|---------|-----------|------------|--------|
| 32 | N/A | Correctness | âœ… |
| 1024 | ~400 | >520 | Phase 3 |
| 32130 | ~1000 | >1300 | Phase 3 |
