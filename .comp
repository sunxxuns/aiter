# FP8 Flash Attention - BF16 Reference Comparison

## Key Discovery

BF16 reference kernel computes **S^T = K @ Q^T**, not S = Q @ K^T.

---

## Why S^T?

### MFMA Output Layout

Thread t, VGPR v holds C[M, N] where:
- M = (t/32)*4 + (v%4) + (v/4)*8
- N = t % 32

### With S = Q @ K^T
```
Thread holds S[row_interleaved, query=t%32]
VGPRs hold different queries → summing mixes queries (WRONG)
```

### With S^T = K @ Q^T
```
Thread holds S^T[key_interleaved, query=t%32]
VGPRs hold different keys for SAME query → summing is row-wise (CORRECT)
```

---

## Implementation Match

| Component | BF16 | FP8 |
|-----------|------|-----|
| QK: K @ Q^T | ✅ | ✅ |
| Max: VGPR + permlane32_swap | ✅ | ✅ |
| Sum: VGPR + permlane32_swap | ✅ | ✅ |
| No ds_swizzle for softmax | ✅ | ✅ |
| P normalize before PV | ✅ | ✅ |

---

## Softmax Pattern

```asm
// VGPR reduction (16 keys per thread)
v_add_f32_e32 v20, v32, v33
...

// Combine thread pairs (same query, different key halves)
v_permlane32_swap_b32_e32 v22, v20
v_add_f32_e32 v18, v20, v22
```

**No ds_swizzle** - that would mix different queries.

---

## Reference Files

| File | Location |
|------|----------|
| BF16 kernel | `hsa/gfx950/fmha_v3_fwd/fwd_hd128_bf16.s` |
| FP8 kernel | `hsa/gfx950/fmha_v3_fwd_fp8/test_full_hd128.s` |
